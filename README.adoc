

#!/bin/bash
# $1 = paramètre donné au docker run, correspond au nom du fichier asciidoc

# On récupère le nom du fichier donné en paramètre
FILE=$1

FILE_NAME=$(basename $FILE)
DIR_NAME=$(dirname $FILE)

SLIDE=/opt/templatesqli/SLIDE
PDF=/opt/templatesqli/PDF
HTML5=/opt/templatesqli/HTML5

# On récupère l'UID de l'owner du fichier asciidoc, car sinon le dossier reveal.js copié
# appartiendra à root et empêchera ses déplacement ou suppression ultérieurs
OWNER=`ls -ld /documents/"$FILE" | awk '{print $3}'`

# Fonction de génération reveal.js HTML du fichier asciidoc
generate-revealjs() {

  if [[ "$IMAGES" == "in-local" ]] ; then
    echo "Les images locales seront utilisées par l'HTML."
    DATAURI=""
  fi

  if [[ "$IMAGES" == "embedded-in-html" ]] || [[ "$IMAGES" == "" ]]; then
    echo "Les images seront incorporées dans le fichier HTML généré."
    DATAURI="-a data-uri"
  fi

  /usr/local/bin/asciidoctor \
  -r asciidoctor-diagram \
  -o "${TARGET_DIRECTORY}/${DIR_NAME}/SLIDE_REVEALJS_"${FILE_NAME%.*}".html" \
  -T /opt/asciidoctor-reveal.js/templates/slim \
  -a backend=revealjs \
  -a revealjs_theme=moon \
  -a revealjs_slideNumber=true \
  $DATAURI \
  ${SOURCE_DIRECTORY}/$FILE && \
  echo "Fichier SLIDE_REVEALJS_"${FILE_NAME%.*}".html généré" && \

  if [[ "$CSS" == "offline" ]] || [[ "$CSS" == "" ]]; then
    echo "Copie du template SQLI en local."
    cp -r /opt/reveal.js ${TARGET_DIRECTORY}
  fi

  if [[ "$CSS" == "online" ]] ; then
    sed -i 's\reveal.js/\http://asciidoc-templates.bordeaux.sqli.com/revealjs/\g' ${TARGET_DIRECTORY}/${DIR_NAME}/SLIDE_REVEALJS_"${FILE_NAME%.*}".html
  fi

}

# Fonction de génération reveal.js HTML avec le thème SQLI du fichier asciidoc
generate-revealjs-sqli() {

  if [[ "$IMAGES" == "in-local" ]] ; then
    echo "Les images locales seront utilisées par l'HTML."
    DATAURI=""
  fi

  if [[ "$IMAGES" == "embedded-in-html" ]] || [[ "$IMAGES" == "" ]]; then
    echo "Les images seront incorporées dans le fichier HTML généré."
    DATAURI="-a data-uri"
  fi

  /usr/local/bin/asciidoctor \
  -r asciidoctor-diagram \
  -o "${TARGET_DIRECTORY}/${DIR_NAME}/SLIDE_REVEALJS_SQLI_"${FILE_NAME%.*}".html"   \
  -T $SLIDE/slim \
  -a cssimagesdir=reveal.js/css/theme/image \
  -a revealjs_parallaxBackgroundImage=reveal.js/css/theme/image/fondnoir.jpg \
  -a title_bg=reveal.js/css/theme/image/fondmarron.jpg \
  -a revealjs_theme=sqlislide \
  -a revealjs_slideNumber=true \
  -a revealjs_parallaxBackgroundSize=cover \
  ${SOURCE_DIRECTORY}/$FILE && \
  echo "Fichier SLIDE_REVEALJS_SQLI_"${FILE_NAME%.*}".html généré."

  if [[ "$CSS" == "offline" ]] || [[ "$CSS" == "" ]]; then
    echo "Copie du template SQLI en local."
    cp -r $SLIDE/reveal.js ${TARGET_DIRECTORY}
  fi

  if [[ "$CSS" == "online" ]] ; then
    sed -i 's\reveal.js/\http://asciidoc-templates.bordeaux.sqli.com/revealjs-template-sqli/\g' ${TARGET_DIRECTORY}/${DIR_NAME}/SLIDE_REVEALJS_SQLI_"${FILE_NAME%.*}".html
  fi

}

# Fonction de génération HTML du fichier asciidoc
generate-html() {

  if [[ "$IMAGES" == "in-local" ]] ; then
    echo "Les images locales seront utilisées par l'HTML."
    DATAURI=""
  fi

  if [[ "$IMAGES" == "embedded-in-html" ]] || [[ "$IMAGES" == "" ]]; then
    echo "Les images seront incorporées dans le fichier HTML généré."
    DATAURI="-a data-uri"
  fi

  /usr/local/bin/asciidoctor \
  $DATAURI \
  -r asciidoctor-diagram \
  -r /opt/asciidoctor-extensions-lab/lib/chart-block-macro.rb \
  -o "${TARGET_DIRECTORY}/${DIR_NAME}/HTML_"${FILE_NAME%.*}".html" \
  ${SOURCE_DIRECTORY}/$FILE && \
  echo "Fichier HTML_"${FILE_NAME%.*}".html généré."
}

# Fonction de génération HTML avec le template SQLI du fichier asciidoc
generate-html-sqli() {

  if [[ "$IMAGES" == "in-local" ]] ; then
    echo "Les images locales seront utilisées par l'HTML."
    DATAURI=""
  fi

  if [[ "$IMAGES" == "embedded-in-html" ]] || [[ "$IMAGES" == "" ]]; then
    echo "Les images seront incorporées dans le fichier HTML généré."
    DATAURI="-a data-uri"
  fi

  /usr/local/bin/asciidoctor \
  -a stylesheet=$HTML5/stylesheets/sqlitemplate.css \
  $DATAURI \
  -r asciidoctor-diagram \
  -o "${TARGET_DIRECTORY}/${DIR_NAME}/HTML_SQLI_"${FILE_NAME%.*}".html" \
  ${SOURCE_DIRECTORY}/$FILE && \
  echo "Fichier HTML_SQLI_"${FILE_NAME%.*}".html généré."

  if [[ "$CSS" == "offline" ]] || [[ "$CSS" == "" ]]; then
    echo "Copie du template SQLI en local."
    cp -r $HTML5/images ${TARGET_DIRECTORY}/${DIR_NAME}/
  fi

  if [[ "$CSS" == "online" ]] ; then
    sed -i 's\url(images\url(http://asciidoc-templates.bordeaux.sqli.com/html-template-sqli/)\g' ${TARGET_DIRECTORY}/HTML_SQLI_"${FILE%.*}".html
  fi
}

# Fonction de génération PDF du fichier asciidoc
generate-pdf() {
  /usr/local/bin/asciidoctor \
  -r asciidoctor-pdf \
  -r asciidoctor-diagram \
  -b pdf \
  -o "${TARGET_DIRECTORY}/${DIR_NAME}/PDF_"${FILE_NAME%.*}".pdf" \
  -a allow-uri-read \
  ${SOURCE_DIRECTORY}/$FILE && \
  echo "Fichier PDF_"${FILE_NAME%.*}".pdf généré."
}

# Fonction de génération PDF avec le thème SQLI du fichier asciidoc
generate-pdf-sqli() {
  /usr/local/bin/asciidoctor \
  -r asciidoctor-pdf \
  -b pdf \
  -r asciidoctor-diagram \
  -a pdf-stylesdir=$PDF/data/themes \
  -a pdf-style=sqli \
  -a pdf-fontsdir=$PDF/data/fonts \
  -a allow-uri-read \
  -o "${TARGET_DIRECTORY}/${DIR_NAME}/PDF_SQLI_"${FILE_NAME%.*}".pdf" \
  ${SOURCE_DIRECTORY}/$FILE && \
  echo "Fichier PDF_SQLI_"${FILE_NAME%.*}".pdf généré."
}


if [[ "$FORMAT" == "pdf" ]] ; then
  generate-pdf
fi

if [[ "$FORMAT" == "pdf-sqli" ]] ; then
  generate-pdf-sqli
fi

if [[ "$FORMAT" == "revealjs" ]] ; then
  generate-revealjs
fi

if [[ "$FORMAT" == "revealjs-sqli" ]] ; then
  generate-revealjs-sqli
fi

if [[ "$FORMAT" == "html" ]] ; then
  generate-html
fi

if [[ "$FORMAT" == "html-sqli" ]] ; then
  generate-html-sqli
fi


# S'il n'y a pas de format précisé, on utilise par défaut l'HTML avec le thème SQLI
if [[ "$FORMAT" == "" ]] ; then
  generate-html-sqli
fi

# On modifie le owner de tous les documents du répertoire de travail
chown -R $OWNER:$OWNER ${TARGET_DIRECTORY}


